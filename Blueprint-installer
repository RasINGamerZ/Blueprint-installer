#!/bin/bash

# =======================================
#   RasIN Blueprints (RG) - Auto Install
#   Powered by RasIN
# =======================================

set -e
trap 'echo "‚ùå Error occurred at line $LINENO. Exiting..."; exit 1' ERR

# --- Logo Banner ---
logo_banner() {
cat << "EOF"
__________               .___ _______    ________                           __________
\______   \_____    _____|   |\      \  /  _____/_____    _____   __________\____    /
 |       _/\__  \  /  ___/   |/   |   \/   \  ___\__  \  /     \_/ __ \_  __ \/     / 
 |    |   \ / __ \_\___ \|   /    |    \    \_\  \/ __ \|  Y Y  \  ___/|  | \/     /_ 
 |____|_  /(____  /____  >___\____|__  /\______  (____  /__|_|  /\___  >__| /_______ \
        \/      \/     \/            \/        \/     \/      \/     \/             \/
========================================
EOF
}

# --- Root Check ---
if [ "$EUID" -ne 0 ]; then
    echo "‚ö†Ô∏è Please run this script as root (use sudo)."
    exit 1
fi

clear
logo_banner
echo ">>> üöÄ Starting RasIN Blueprints (RG) Setup..."

# Step 1: Install Node.js 20.x
echo ">>> Installing Node.js 20.x..."
apt-get install -y ca-certificates curl gnupg
mkdir -p /etc/apt/keyrings
curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | \
  gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | \
  tee /etc/apt/sources.list.d/nodesource.list
apt-get update
apt-get install -y nodejs

# Step 2: Install Yarn & dependencies
echo ">>> Installing dependencies..."
npm i -g yarn
apt install -y zip unzip git curl wget

# Step 3: Setup in Pterodactyl directory
cd /var/www/pterodactyl || { echo "‚ùå Pterodactyl directory not found!"; exit 1; }
yarn

# Step 4: Download RasIN Hosting release
echo ">>> Downloading latest RasIN Hosting release..."
wget "$(curl -s https://api.github.com/repos/BlueprintFramework/framework/releases/latest | \
grep 'browser_download_url' | cut -d '"' -f 4)" -O release.zip

echo ">>> Extracting release files..."
unzip -o release.zip

# Step 5: Run blueprint.sh
if [ ! -f "blueprint.sh" ]; then
    echo "‚ùå Error: blueprint.sh not found in release package."
    exit 1
fi

chmod +x blueprint.sh
echo ">>> Running blueprint.sh for RasIN Blueprints..."
bash blueprint.sh

echo "‚úÖ RasIN Blueprints (RG) setup completed successfully (!"
